---
import Layout from '../../layouts/Layout.astro';
import StatCard from '../../components/StatCard.astro';
import ScoreBar from '../../components/ScoreBar.astro';
import { loadResults, getLatestVersion, loadTasks, formatScore } from '../../lib/data';

export async function getStaticPaths() {
  const latestVersion = await getLatestVersion();
  if (!latestVersion) return [];
  
  // Generate paths only for the latest version's models
  const results = await loadResults(latestVersion);
  return results.map((result) => ({
    params: { id: result.modelId },
    props: { result, version: latestVersion },
  }));
}

const { result, version } = Astro.props;
const tasks = await loadTasks();
const taskMap = new Map(tasks.map((t) => [t.id, t]));

const avgLatency = result.tasks?.length
  ? Math.round(result.tasks.reduce((sum, t) => sum + t.latencyMs, 0) / result.tasks.length)
  : 0;

const getScoreColor = (score: number) => {
  if (score >= 0.8) return 'text-emerald-600';
  if (score >= 0.6) return 'text-cyan-600';
  if (score >= 0.4) return 'text-amber-600';
  return 'text-red-600';
};
---

<Layout title={`${result.modelId} - MBSE Benchmark`} currentPage="models" currentVersion={version}>
  <div class="mb-8">
    <a href="/models/" class="inline-flex items-center text-blue-600 hover:text-blue-700 text-sm mb-4 font-medium">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Models
    </a>
    <div class="flex items-center space-x-3">
      <h1 class="text-3xl font-bold text-slate-900">{result.modelId}</h1>
      <span class="px-2 py-1 text-xs font-mono bg-slate-100 text-slate-600 rounded border border-slate-200">
        {result.version}
      </span>
    </div>
    <p class="text-slate-500 mt-1">Benchmark results and task-level performance</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <StatCard label="Overall Score" value={formatScore(result.score)} icon="ðŸ“Š" />
    <StatCard label="Tasks Completed" value={result.tasks?.length ?? 0} icon="âœ“" />
    <StatCard label="Avg Latency" value={`${avgLatency}ms`} icon="âš¡" />
    <StatCard label="Version" value={result.version} icon="ðŸ“‹" />
  </div>

  <div class="card rounded-xl p-6 mb-8">
    <div class="flex items-center justify-between mb-3">
      <span class="text-slate-600 font-medium">Overall Performance</span>
      <span class={`font-mono font-semibold ${getScoreColor(result.score)}`}>{formatScore(result.score)}</span>
    </div>
    <ScoreBar value={result.score} size="lg" showLabel={false} />
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold text-slate-900">Task Results</h2>
    <p class="text-slate-500 text-sm">Detailed breakdown of performance on each benchmark task</p>
  </div>

  {(result.tasks ?? []).map((taskResult) => {
    const taskDef = taskMap.get(taskResult.taskId);
    return (
      <div class="card rounded-xl p-6 mb-4">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="font-semibold text-lg text-slate-900">{taskDef?.name ?? taskResult.taskId}</h3>
            <p class="text-slate-500 text-sm">{taskDef?.description ?? ''}</p>
          </div>
          <div class="text-right">
            <div class={`font-bold text-xl ${getScoreColor(taskResult.score)}`}>
              {formatScore(taskResult.score)}
            </div>
            <div class="text-slate-500 text-sm font-mono">{taskResult.latencyMs}ms</div>
          </div>
        </div>

        <details class="mb-4">
          <summary class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold cursor-pointer hover:text-slate-700">Prompt</summary>
          <div class="terminal mt-2">
            <div class="terminal-body text-sm">
              {taskDef?.prompt ?? 'N/A'}
            </div>
          </div>
        </details>

        <details>
          <summary class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold cursor-pointer hover:text-slate-700">Response</summary>
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-700 max-h-48 overflow-y-auto whitespace-pre-wrap mt-2">
            {taskResult.finalResponse || <em class="text-slate-400">No response</em>}
          </div>
        </details>

        {taskResult.evaluation && (
          <details class="mt-4">
            <summary class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold cursor-pointer hover:text-slate-700">Evaluation</summary>
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm mt-2">
              <div class="text-slate-700 mb-2">{taskResult.evaluation.explanation}</div>
              {(taskResult.evaluation.details?.matched ?? []).length > 0 && (
                <div class="mb-2">
                  <span class="text-emerald-600 font-medium">âœ“ Passed:</span>
                  <ul class="list-disc list-inside text-slate-600 ml-2">
                    {(taskResult.evaluation.details?.matched ?? []).map((m) => <li>{m}</li>)}
                  </ul>
                </div>
              )}
              {(taskResult.evaluation.details?.missing ?? []).length > 0 && (
                <div>
                  <span class="text-red-600 font-medium">âœ— Failed:</span>
                  <ul class="list-disc list-inside text-slate-600 ml-2">
                    {(taskResult.evaluation.details?.missing ?? []).map((m) => <li>{m}</li>)}
                  </ul>
                </div>
              )}
            </div>
          </details>
        )}

        {taskResult.iterations && taskResult.iterations.length > 0 && (
          <details class="mt-4">
            <summary class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold cursor-pointer hover:text-slate-700">
              Iterations ({taskResult.iterations.length})
            </summary>
            <div class="space-y-4 mt-2">
              {taskResult.iterations.map((iter) => (
                <details class="border border-slate-200 rounded-lg bg-slate-50">
                  <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-100">
                    <span class="font-medium text-slate-700">Iteration {iter.iteration}</span>
                    <span class="text-xs font-mono text-slate-500">{iter.latencyMs}ms</span>
                  </summary>
                  <div class="p-4 pt-0 space-y-3">
                    {iter.response && (
                      <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider mb-1">Response</div>
                        <div class="bg-white border border-slate-200 rounded p-3 text-sm text-slate-700 max-h-32 overflow-y-auto whitespace-pre-wrap">
                          {iter.response}
                        </div>
                      </div>
                    )}
                    
                    {iter.toolCalls && iter.toolCalls.length > 0 && (
                      <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider mb-1">Tool Calls ({iter.toolCalls.length})</div>
                        <div class="space-y-2">
                          {iter.toolCalls.map((call) => (
                            <div class="bg-white border border-slate-200 rounded p-3" key={call.id}>
                              <div class="flex items-center space-x-2 mb-1">
                                <span class="text-xs font-mono bg-blue-100 text-blue-700 px-2 py-0.5 rounded">{call.name}</span>
                                <span class="text-xs text-slate-400 font-mono">{call.id}</span>
                              </div>
                              <pre class="text-xs text-slate-600 overflow-x-auto">{JSON.stringify(call.arguments, null, 2)}</pre>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {iter.toolResults && iter.toolResults.length > 0 && (
                      <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider mb-1">Tool Results ({iter.toolResults.length})</div>
                        <div class="space-y-2">
                          {iter.toolResults.map((res, index) => (
                            <div class="bg-white border border-slate-200 rounded p-3" key={`${res.tool}-${index}`}>
                              <div class="text-xs font-mono text-emerald-600 mb-1">{res.tool}</div>
                              <pre class="text-xs text-slate-600 overflow-x-auto max-h-24 overflow-y-auto">{JSON.stringify(res.result, null, 2)}</pre>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </details>
              ))}
            </div>
          </details>
        )}
      </div>
    );
  })}
</Layout>
