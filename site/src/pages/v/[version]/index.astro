---
import Layout from '../../../layouts/Layout.astro';
import StatCard from '../../../components/StatCard.astro';
import ScoreBar from '../../../components/ScoreBar.astro';
import RankBadge from '../../../components/RankBadge.astro';
import { loadResults, getAllVersions, formatScore, formatDate } from '../../../lib/data';

export async function getStaticPaths() {
  const allVersions = await getAllVersions();
  return allVersions.map((version) => ({
    params: { version },
    props: { version },
  }));
}

const { version } = Astro.props;
const results = await loadResults(version);
const allVersions = await getAllVersions();
const topModel = results[0];
const avgScore = results.length > 0 
  ? results.reduce((sum, r) => sum + r.score, 0) / results.length 
  : 0;
---

<Layout title={`MBSE Benchmark - v${version}`} currentPage="leaderboard" currentVersion={version}>
  <div class="mb-8">
    <div class="flex items-center space-x-3 mb-2">
      <h1 class="text-3xl font-bold text-slate-900">Leaderboard</h1>
      <span class="px-2 py-1 text-xs font-mono bg-blue-50 text-blue-700 rounded border border-blue-200">
        v{version}
      </span>
    </div>
    <p class="text-slate-500">AI model performance rankings on Model-Based Systems Engineering tasks</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <StatCard 
      label="Top Model" 
      value={topModel?.modelId ?? 'N/A'} 
      subtext={topModel ? formatScore(topModel.score) : undefined}
      icon="ðŸ†"
    />
    <StatCard label="Models Tested" value={results.length} icon="ðŸ¤–" />
    <StatCard label="Average Score" value={formatScore(avgScore)} icon="ðŸ“Š" />
    <StatCard label="Benchmark Versions" value={allVersions.length} icon="ðŸ“‹" />
  </div>

  {results.length === 0 ? (
    <div class="card rounded-xl p-12 text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
        <span class="text-3xl">ðŸ“Š</span>
      </div>
      <h2 class="text-xl font-semibold text-slate-900 mb-2">No Results Yet</h2>
      <p class="text-slate-500 mb-6">Run the benchmark to see model rankings here.</p>
    </div>
  ) : (
    <div class="card rounded-xl overflow-hidden">
      <table class="w-full">
        <thead class="bg-slate-50 border-b border-slate-200">
          <tr class="text-left text-slate-500 text-xs uppercase tracking-wider">
            <th class="py-4 px-6 font-semibold">Rank</th>
            <th class="py-4 px-6 font-semibold">Model</th>
            <th class="py-4 px-6 font-semibold">Score</th>
            <th class="py-4 px-6 font-semibold">Tasks</th>
            <th class="py-4 px-6 font-semibold">Version</th>
            <th class="py-4 px-6 font-semibold">Date</th>
          </tr>
        </thead>
        <tbody>
          {results.map((result, i) => (
            <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
              <td class="py-4 px-6">
                <RankBadge rank={i + 1} />
              </td>
              <td class="py-4 px-6">
                <a href={`/v/${version}/models/${result.modelId}/`} class="font-medium text-slate-900 hover:text-blue-600 transition-colors">
                  {result.modelId}
                </a>
              </td>
              <td class="py-4 px-6 w-48">
                <ScoreBar value={result.score} />
              </td>
              <td class="py-4 px-6 text-slate-500 text-sm">
                {result.tasks?.length ?? 0} tasks
              </td>
              <td class="py-4 px-6">
                <span class="px-2 py-1 text-xs font-mono rounded bg-slate-100 text-slate-600 border border-slate-200">
                  {result.version}
                </span>
              </td>
              <td class="py-4 px-6 text-slate-500 text-sm">
                {formatDate(result.timestamp)}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}
</Layout>
