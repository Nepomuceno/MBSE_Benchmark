---
import Layout from '../../../../../layouts/Layout.astro';
import StatCard from '../../../../../components/StatCard.astro';
import ScoreBar from '../../../../../components/ScoreBar.astro';
import { loadResults, getAllVersions, loadTasks, formatScore } from '../../../../../lib/data';

export async function getStaticPaths() {
  const allVersions = await getAllVersions();
  const paths = [];
  
  // Generate paths for each version's models
  for (const version of allVersions) {
    const results = await loadResults(version);
    for (const result of results) {
      paths.push({
        params: { version, id: result.modelId },
        props: { result, version },
      });
    }
  }
  
  return paths;
}

const { result, version } = Astro.props;
const tasks = await loadTasks();
const taskMap = new Map(tasks.map((t) => [t.id, t]));

const avgLatency = result.tasks?.length
  ? Math.round(result.tasks.reduce((sum, t) => sum + t.latencyMs, 0) / result.tasks.length)
  : 0;

const getScoreColor = (score: number) => {
  if (score >= 0.8) return 'text-emerald-600';
  if (score >= 0.6) return 'text-cyan-600';
  if (score >= 0.4) return 'text-amber-600';
  return 'text-red-600';
};
---

<Layout title={`${result.modelId} - MBSE Benchmark`} currentPage="models" currentVersion={version}>
  <div class="mb-8">
    <a href={`/v/${version}/`} class="inline-flex items-center text-blue-600 hover:text-blue-700 text-sm mb-4 font-medium">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Leaderboard
    </a>
    <div class="flex items-center space-x-3">
      <h1 class="text-3xl font-bold text-slate-900">{result.modelId}</h1>
      <span class="px-2 py-1 text-xs font-mono bg-slate-100 text-slate-600 rounded border border-slate-200">
        {result.version}
      </span>
    </div>
    <p class="text-slate-500 mt-1">Benchmark results and task-level performance</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <StatCard label="Overall Score" value={formatScore(result.score)} icon="ðŸ“Š" />
    <StatCard label="Tasks Completed" value={result.tasks?.length ?? 0} icon="âœ“" />
    <StatCard label="Avg Latency" value={`${avgLatency}ms`} icon="âš¡" />
    <StatCard label="Version" value={result.version} icon="ðŸ“‹" />
  </div>

  <div class="card rounded-xl p-6 mb-8">
    <div class="flex items-center justify-between mb-3">
      <span class="text-slate-600 font-medium">Overall Performance</span>
      <span class={`font-mono font-semibold ${getScoreColor(result.score)}`}>{formatScore(result.score)}</span>
    </div>
    <ScoreBar value={result.score} size="lg" showLabel={false} />
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold text-slate-900">Task Results</h2>
    <p class="text-slate-500 text-sm">Detailed breakdown of performance on each benchmark task</p>
  </div>

  {(result.tasks ?? []).map((taskResult) => {
    const taskDef = taskMap.get(taskResult.taskId);
    return (
      <div class="card rounded-xl p-6 mb-4">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="font-semibold text-lg text-slate-900">{taskDef?.name ?? taskResult.taskId}</h3>
            <p class="text-slate-500 text-sm">{taskDef?.description ?? ''}</p>
          </div>
          <div class="text-right">
            <div class={`font-bold text-xl ${getScoreColor(taskResult.score)}`}>
              {formatScore(taskResult.score)}
            </div>
            <div class="text-slate-500 text-sm font-mono">{taskResult.latencyMs}ms</div>
          </div>
        </div>

        <div class="mb-4">
          <div class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold">Prompt</div>
          <div class="terminal">
            <div class="terminal-body text-sm">
              {taskDef?.prompt ?? 'N/A'}
            </div>
          </div>
        </div>

        <div>
          <div class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold">Response</div>
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-700 max-h-48 overflow-y-auto whitespace-pre-wrap">
            {taskResult.finalResponse || <em class="text-slate-400">No response</em>}
          </div>
        </div>

        {taskResult.evaluation && (
          <div class="mt-4">
            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold">Evaluation</div>
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm">
              <div class="text-slate-700 mb-2">{taskResult.evaluation.explanation}</div>
              {taskResult.evaluation.details.matched.length > 0 && (
                <div class="mb-2">
                  <span class="text-emerald-600 font-medium">âœ“ Passed:</span>
                  <ul class="list-disc list-inside text-slate-600 ml-2">
                    {taskResult.evaluation.details.matched.map((m) => <li>{m}</li>)}
                  </ul>
                </div>
              )}
              {taskResult.evaluation.details.missing.length > 0 && (
                <div>
                  <span class="text-red-600 font-medium">âœ— Failed:</span>
                  <ul class="list-disc list-inside text-slate-600 ml-2">
                    {taskResult.evaluation.details.missing.map((m) => <li>{m}</li>)}
                  </ul>
                </div>
              )}
            </div>
          </div>
        )}

        {taskResult.iterations && taskResult.iterations.length > 0 && (
          <div class="mt-4">
            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2 font-semibold">
              Iterations ({taskResult.iterations.length})
            </div>
            <div class="text-slate-600 text-sm">
              Model completed task in {taskResult.iterations.length} iteration(s)
            </div>
          </div>
        )}
      </div>
    );
  })}
</Layout>
